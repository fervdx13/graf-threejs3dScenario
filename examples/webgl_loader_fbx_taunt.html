<!DOCTYPE html>
<html lang="en">
    <head>
        <title>three.js webgl - FBX loader</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
        <link type="text/css" rel="stylesheet" href="main.css">
    </head>

    <body>
        <div id="info">
            <a href="https://threejs.org" target="_blank" rel="noopener">three.js</a> - FBXLoader<br />
            Character and animation from <a href="https://www.mixamo.com/" target="_blank" rel="noopener">Mixamo</a>
            (Haz Clic o Presiona Tecla para iniciar la Música)
        </div>

        <script type="importmap">
            {
                "imports": {
                    "three": "https://unpkg.com/three@0.155.0/build/three.module.js",
                    "three/addons/": "https://unpkg.com/three@0.155.0/examples/jsm/"
                }
            }
        </script>
        <script type="module">

            import * as THREE from 'three';

            import Stats from 'three/addons/libs/stats.module.js';

            import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
            import { FBXLoader } from 'three/addons/loaders/FBXLoader.js';
            import { GUI } from 'three/addons/libs/lil-gui.module.min.js';
            
            // --- ADICIONES DE MÓDULOS ---
            import { RGBELoader } from 'three/addons/loaders/RGBELoader.js';
            import { Audio, AudioListener, AudioLoader } from 'three';

            const manager = new THREE.LoadingManager();

            let camera, scene, renderer, stats, object, loader, guiMorphsFolder;
            let mixer;
            let sound; // Variable global para el objeto de audio

            const clock = new THREE.Clock();

            const params = {
                asset: 'Taunt' 
            };

            const assets = [
                'Taunt',
                'morph_test',
                'monkey',
                'monkey_embedded_texture',
                'vCube',
            ];


            init();


            function init() {

                const container = document.createElement( 'div' );
                document.body.appendChild( container );

                camera = new THREE.PerspectiveCamera( 45, window.innerWidth / window.innerHeight, 1, 2000 );
                camera.position.set( 100, 200, 300 );

                scene = new THREE.Scene();
                scene.background = new THREE.Color( 0xa0a0a0 );
                
                // --- EFECTO ADICIONAL: NIEBLA DE COLOR (Marrón Rojizo) ---
                scene.fog = new THREE.Fog( 0x8B4513, 100, 700 ); 
                // --------------------------------------------------------

                // lights
                const hemiLight = new THREE.HemisphereLight( 0xffffff, 0x444444, 5 );
                hemiLight.position.set( 0, 200, 0 );
                scene.add( hemiLight );

                const dirLight = new THREE.DirectionalLight( 0xffffff, 5 );
                dirLight.position.set( 0, 200, 100 );
                dirLight.castShadow = true;
                dirLight.shadow.camera.top = 180;
                dirLight.shadow.camera.bottom = - 100;
                dirLight.shadow.camera.left = - 120;
                dirLight.shadow.camera.right = 120;
                scene.add( dirLight );

                // ground
                // PISO CORREGIDO: MeshBasicMaterial para IGNORAR la niebla de color
                const mesh = new THREE.Mesh( 
                    new THREE.PlaneGeometry( 2000, 2000 ), 
                    new THREE.MeshBasicMaterial( { 
                        color: 0xc8c8c8, 
                        depthWrite: false 
                    } ) 
                );
                mesh.rotation.x = - Math.PI / 2;
                mesh.receiveShadow = true;
                scene.add( mesh );

                const grid = new THREE.GridHelper( 2000, 20, 0x000000, 0x000000 );
                grid.material.opacity = 0.2;
                grid.material.transparent = true;
                scene.add( grid );
            
                loader = new FBXLoader( manager );
                loadAsset( params.asset );

                renderer = new THREE.WebGLRenderer( { antialias: true } );
                renderer.setPixelRatio( window.devicePixelRatio );
                renderer.setSize( window.innerWidth, window.innerHeight );
                renderer.setAnimationLoop( animate );
                renderer.shadowMap.enabled = true;
                container.appendChild( renderer.domElement );

                const controls = new OrbitControls( camera, renderer.domElement );
                controls.target.set( 0, 100, 0 );
                controls.update();

                window.addEventListener( 'resize', onWindowResize );

                // stats
                stats = new Stats();
                container.appendChild( stats.dom );

                const gui = new GUI();
                gui.add( params, 'asset', assets ).onChange( function ( value ) {
                    loadAsset( value );
                } );

                guiMorphsFolder = gui.addFolder( 'Morphs' ).hide();

                // --- ADICIÓN DE ESCENARIO HDR ---
                const rgbeLoader = new RGBELoader();
                rgbeLoader.load('models/rgbe/university_workshop_4k.hdr', function (texture) {
                    texture.mapping = THREE.EquirectangularReflectionMapping;
                    scene.background = texture;
                    scene.environment = texture; 
                });
                
                // --- ADICIÓN DE AUDIO MP3 ---
                const listener = new AudioListener();
                camera.add(listener);

                sound = new Audio(listener);
                const audioLoader = new AudioLoader();
                audioLoader.load('models/rgbe/Song.mp3', function (buffer) {
                    sound.setBuffer(buffer);
                    sound.setLoop(true);
                    sound.setVolume(0.5);
                });
                
                // Inicia el audio al hacer clic o presionar una tecla
                window.addEventListener('click', startAudio, { once: true });
                window.addEventListener('keydown', startAudio, { once: true });
                
                function startAudio() {
                    if (sound && sound.buffer) {
                        sound.play();
                        const infoDiv = document.getElementById('info');
                        if (infoDiv) infoDiv.innerHTML = '<a href="https://threejs.org" target="_blank" rel="noopener">three.js</a> - FBXLoader<br />Música Reproduciéndose (Taunt)';
                    }
                }


            }

            //

            function loadAsset( asset ) {

                loader.load( 'models/fbx/' + asset + '.fbx', function ( group ) {

                    if ( object ) {

                        object.traverse( function ( child ) {

                            if ( child.isSkinnedMesh ) {
                                child.skeleton.dispose();
                            }

                            if ( child.material ) {

                                const materials = Array.isArray( child.material ) ? child.material : [ child.material ];
                                materials.forEach( material => {
                                    if ( material.map ) material.map.dispose();
                                    material.dispose();
                                } );
                            }
                        
                            if ( child.geometry ) child.geometry.dispose();

                        } );

                        scene.remove( object );

                    }

                    //

                    object = group;

                    if ( object.animations && object.animations.length ) {

                        mixer = new THREE.AnimationMixer( object );

                        const action = mixer.clipAction( object.animations[ 0 ] );
                        action.play();

                    } else {

                        mixer = null;

                    }

                    guiMorphsFolder.children.forEach( ( child ) => child.destroy() );
                    guiMorphsFolder.hide();

                    object.traverse( function ( child ) {

                        if ( child.isMesh ) {

                            // --- MATERIAL: RESTAURAR Y APLICAR PBR AL ORIGINAL ---
                            if (child.material) {
                                child.material = new THREE.MeshStandardMaterial().copy(child.material);
                                
                                // Ajustes finos de PBR 
                                child.material.roughness = 0.6; 
                                child.material.metalness = 0.1;
                            }
                            // -----------------------------------------------------

                            child.castShadow = true;
                            child.receiveShadow = true;

                            if ( child.morphTargetDictionary ) {

                                guiMorphsFolder.show();
                                const meshFolder = guiMorphsFolder.addFolder( child.name || child.uuid );
                                Object.keys( child.morphTargetDictionary ).forEach( ( key ) => {
                                    meshFolder.add( child.morphTargetInfluences, child.morphTargetDictionary[ key ], 0, 1, 0.01 );
                                } );
                            }

                        }

                    } );

                    scene.add( object );

                } );

            }

            //

            function onWindowResize() {

                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();

                renderer.setSize( window.innerWidth, window.innerHeight );

            }

            //

            function animate() {

                const delta = clock.getDelta();

                if ( mixer ) mixer.update( delta );

                renderer.render( scene, camera );
                stats.update();
            }
        </script>

    </body>
</html>